<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>틀린 문제 등록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        .container { max-width: 520px; margin: 48px auto; padding: 24px; position: relative; }
        .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
        .center { text-align: center; }
        .row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
        label { font-weight: 600; }
        input, select, button { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
        button { background: #111827; color: #fff; cursor: pointer; border: none; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .msg { margin-bottom: 16px; padding: 10px 12px; border-radius: 10px; display: none; }
        .msg.ok { background: #ecfdf5; color: #065f46; border: 1px solid #10b981; }
        .msg.err { background: #fef2f2; color: #991b1b; border: 1px solid #ef4444; }
        .help { color: #6b7280; font-size: 12px; }

        /* 설정 아이콘 (오른쪽 상단) */
        .gear-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            padding: 6px;
            cursor: pointer;
            border-radius: 8px;
        }
        .gear-btn:hover { background: #f3f4f6; }

        /* 모달 */
        .modal-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.4);
            display: none;
            align-items: center; justify-content: center;
            padding: 16px;
            z-index: 50;
        }
        .modal {
            width: 100%; max-width: 520px;
            background: #fff; border: 1px solid #e5e7eb; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
            padding: 20px;
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px;
        }
        .modal-title { font-weight: 700; font-size: 16px; }
        .close-btn {
            background: transparent; border: none; font-size: 20px; line-height: 1; cursor: pointer; padding: 4px 8px;
        }
        .info-list { margin: 12px 0 16px; padding: 0; list-style: none; display: grid; gap: 8px; }
        .info-row { display: grid; grid-template-columns: 110px 1fr; gap: 10px; font-size: 14px; }
        .info-key { color: #6b7280; }
        .pill { display:inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 12px; border:1px solid #e5e7eb; }
        .pill.on { background:#ecfdf5; color:#065f46; border-color:#10b981; }
        .pill.off { background:#fef2f2; color:#991b1b; border-color:#ef4444; }

        .action-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #d1d5db; background: #111827; color: #fff; cursor:pointer; }
        .btn.secondary { background: #fff; color: #111827; }
        .btn.danger { background: #b91c1c; border-color:#b91c1c; color:#fff; }
        .muted { color:#6b7280; font-size:12px; }

        /* 탈퇴 확인 바텀시트 */
        .confirm-sheet {
            border-top:1px solid #e5e7eb; margin-top:12px; padding-top:12px;
            display:none;
        }
        .confirm-row { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    </style>
</head>
<body>
<div class="container">
    <!-- 상단 메시지 -->
    <div id="globalMsg" class="msg"></div>

    <div class="card">
        <!-- 설정(톱니) 버튼 -->
        <button id="openSettings" class="gear-btn" title="설정">
            <!-- 간단한 톱니 SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#111827" stroke-width="1.5"/>
                <path d="M19.4 13.5a7.6 7.6 0 0 0 0-3l2-1.2-1.8-3.1-2.3.7a7.7 7.7 0 0 0-2.6-1.5l-.4-2.3h-3.6l-.4 2.3c-.9.3-1.8.8-2.6 1.5l-2.3-.7-1.8 3.1 2 1.2a7.6 7.6 0 0 0 0 3l-2 1.2 1.8 3.1 2.3-.7c.8.7 1.7 1.2 2.6 1.5l.4 2.3h3.6l.4-2.3c.9-.3 1.8-.8 2.6-1.5l2.3.7 1.8-3.1-2-1.2Z" stroke="#111827" stroke-width="1.5"/>
            </svg>
        </button>

        <h2 class="center" style="margin-top:0">틀린 문제 등록</h2>
        <p id="welcome" class="center help" style="margin-top:4px;">불러오는 중...</p>

        <form id="wrongForm" autocomplete="off">
            <div class="row">
                <label for="platformId">플랫폼</label>
                <select id="platformId" name="platformId" required>
                    <option value="" disabled selected>플랫폼을 선택하세요</option>
                </select>
            </div>

            <div class="row">
                <label for="num">문제 번호</label>
                <input id="num" name="num" inputmode="numeric" pattern="[0-9]*" type="number" required placeholder="숫자만 입력">
            </div>

            <div class="row">
                <label for="date">틀린 날짜</label>
                <input id="date" name="date" type="date" required>
            </div>

            <input type="hidden" id="_csrfParam" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
            <!-- 등록/로그아웃 버튼 -->
            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button id="submitBtn" type="submit">등록</button>
                <button id="logoutBtn" type="button">로그아웃</button>
            </div>
        </form>
        <form id="logoutForm" th:action="@{/auth/logout}" method="post" style="display:none;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </div>
</div>

<!-- 설정 모달 -->
<div id="settingsModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">내 계정 설정</div>
            <button class="close-btn" id="closeSettings" aria-label="닫기">×</button>
        </div>

        <ul class="info-list">
            <li class="info-row"><div class="info-key">수신 이메일</div><div id="infoEmail">-</div></li>
            <li class="info-row"><div class="info-key">닉네임</div><div id="infoUsername">-</div></li>
            <li class="info-row"><div class="info-key">가입 일시</div><div id="infoCreatedAt">-</div></li>
            <li class="info-row">
                <div class="info-key">수신 여부</div>
                <div>
                    <span id="infoWanted" class="pill">-</span>
                </div>
            </li>
        </ul>

        <div class="action-row">
            <button class="btn secondary" id="btnOn">활성화</button>
            <button class="btn secondary" id="btnOff">비활성화</button>
        </div>

        <div class="action-row" style="justify-content: space-between; align-items: center;">
            <span class="muted">계정을 더 이상 사용하지 않는다면 아래에서 탈퇴할 수 있어요.</span>
            <button class="btn danger" id="btnQuitOpen">회원 탈퇴</button>
        </div>

        <!-- 탈퇴 확인 시트 -->
        <div id="quitSheet" class="confirm-sheet">
            <div><strong>정말 탈퇴하시겠습니까?</strong></div>
            <div class="muted">탈퇴를 누르면 계정과 데이터가 삭제될 수 있습니다.</div>
            <div class="confirm-row">
                <button class="btn secondary" id="btnQuitCancel" type="button">취소</button>
                <button class="btn danger" id="btnQuitConfirm" type="button">확인</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ----- 쿠키 유틸 -----
    function getCookie(name) {
        return document.cookie
            .split('; ')
            .find(row => row.startsWith(name + '='))
            ?.split('=')[1];
    }
    function deleteCookie(name) {
        // 기본 경로
        document.cookie = `${name}=; Max-Age=0; Path=/;`;
        document.cookie = `${name}=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/;`;

        // (옵션) 서브도메인까지 지우기 — 필요 없으면 아래 for문은 제거해도 됨
        const parts = location.hostname.split('.');
        for (let i = 0; i < parts.length - 1; i++) {
            const domain = '.' + parts.slice(i).join('.');
            document.cookie = `${name}=; Max-Age=0; Path=/; Domain=${domain};`;
            document.cookie = `${name}=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; Domain=${domain};`;
        }
    }

    // ----- 메시지 표시 -----
    function showMessage(text, ok = true) {
        const el = document.getElementById('globalMsg');
        el.textContent = text;
        el.classList.remove('ok', 'err');
        el.classList.add(ok ? 'ok' : 'err');
        el.style.display = 'block';
    }

    // ----- 오늘 yyyy-MM-dd -----
    function todayStr() {
        const d = new Date();
        const mm = String(d.getMonth()+1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${d.getFullYear()}-${mm}-${dd}`;
    }

    // ----- 초기 로드 -----
    async function init() {
        document.getElementById('date').value = todayStr();

        // 유저네임
        try {
            const res = await fetch('/api/users/my-username', { credentials: 'include' });
            const text = await res.text();
            document.getElementById('welcome').textContent = `${text}님 반가워요!`;
        } catch (e) {
            document.getElementById('welcome').textContent = '유저네임을 불러오지 못했습니다.';
            showMessage('유저네임 조회 실패', false);
        }

        // 플랫폼 전체 리스트
        try {
            const res = await fetch('/api/platform/all', { credentials: 'include' });
            const data = await res.json();

            const sel = document.getElementById('platformId');
            sel.innerHTML = '<option value="" disabled selected>플랫폼을 선택하세요</option>';

            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.platformId;
                opt.textContent = item.name;
                sel.appendChild(opt);
            });
        } catch (e) {
            showMessage('플랫폼 목록 조회 실패', false);
        }
    }

    // ----- FormData로 등록 -----
    document.getElementById('wrongForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        try {
            const form = e.target;
            const formData = new FormData(form);
            const xsrf = decodeURIComponent(getCookie('XSRF-TOKEN') || '');

            const res = await fetch('/api/wrong', {
                method: 'POST',
                credentials: 'include',
                headers: { 'X-XSRF-TOKEN': xsrf },
                body: formData
            });

            const bodyText = await res.text();
            let displayMsg = bodyText;

            if (!res.ok) {
                try {
                    const json = JSON.parse(bodyText);
                    if (json.message) displayMsg = json.message;
                } catch (_) {}
            }
            showMessage(displayMsg, res.ok);
        } catch (err) {
            showMessage('요청 실패: ' + (err?.message || 'unknown'), false);
        } finally {
            btn.disabled = false;
        }
    });

    // ----- 로그아웃 -----
    document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('logoutForm').submit();
    });

    // =========================
    //    설정 모달 관련 로직
    // =========================
    const modal = document.getElementById('settingsModal');
    const quitSheet = document.getElementById('quitSheet');

    function openModal() {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
    }
    function closeModal() {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        hideQuitSheet();
    }
    function showQuitSheet() { quitSheet.style.display = 'block'; }
    function hideQuitSheet() { quitSheet.style.display = 'none'; }

    // 설정 아이콘 클릭 → 정보 로드 후 모달 표시
    document.getElementById('openSettings').addEventListener('click', async () => {
        try {
            const res = await fetch('/api/users/my-info', { credentials: 'include' });
            const data = await res.json();

            // 데이터 바인딩 (키 이름은 백엔드 응답 스펙에 맞춰 조정)
            document.getElementById('infoEmail').textContent = data.email ?? '-';
            document.getElementById('infoUsername').textContent = data.username ?? '-';
            document.getElementById('infoCreatedAt').textContent = data.createdAt ?? '-';

            const wantedEl = document.getElementById('infoWanted');
            const isOn = (data.isWanted === 1 || data.isWanted === true || data.isWanted === '1');
            wantedEl.textContent = isOn ? 'ON' : 'OFF';
            wantedEl.classList.remove('on','off');
            wantedEl.classList.add(isOn ? 'on' : 'off');

            openModal();
        } catch (e) {
            showMessage('회원 정보를 불러오지 못했습니다.', false);
        }
    });

    document.getElementById('closeSettings').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // 공통 POST + 리다이렉션
    async function postAndRedirect(url, redirectUrl) {
        try {
            const xsrf = decodeURIComponent(getCookie('XSRF-TOKEN') || '');
            const res = await fetch(url, {
                method: 'POST',
                credentials: 'include',
                headers: { 'X-XSRF-TOKEN': xsrf }
            });
            // 성공/실패 상관없이 서버가 상태코드를 내려줄 수 있음 → 그냥 리다이렉트
            window.location.href = redirectUrl;
        } catch (e) {
            // 네트워크 에러 등만 메시지
            showMessage('요청 실패: ' + (e?.message || 'unknown'), false);
        }
    }

    // 탈퇴 후 리다이렉션
    /* === 탈퇴 처리 === */
    async function quitAndRedirect() {
        const confirmBtn = document.getElementById('btnQuitConfirm');
        const cancelBtn  = document.getElementById('btnQuitCancel');
        confirmBtn.disabled = true; cancelBtn.disabled = true;

        try {
            const xsrf = decodeURIComponent(getCookie('XSRF-TOKEN') || '');
            const res = await fetch('/api/users/quit', {
                method: 'POST',
                credentials: 'include',
                headers: { 'X-XSRF-TOKEN': xsrf }
            });

            // 서버가 세션 무효화하더라도 클라 쿠키도 정리
            deleteCookie('JSESSIONID');
            deleteCookie('XSRF-TOKEN');

            if (res.ok) {
                window.location.href = '/login?quitSuccess';
            } else {
                let msg = '회원 탈퇴 실패';
                try {
                    const data = await res.json();
                    msg = data.message || JSON.stringify(data);
                } catch { msg = await res.text(); }
                alert(msg);
            }
        } catch (e) {
            alert('요청 실패: ' + (e?.message || '알 수 없음'));
        } finally {
            confirmBtn.disabled = false; cancelBtn.disabled = false;
            hideQuitSheet();
        }
    }

    // 활성화/비활성화 버튼
    document.getElementById('btnOn').addEventListener('click', () => {
        postAndRedirect('/api/users/on-email', '/');
    });
    document.getElementById('btnOff').addEventListener('click', () => {
        postAndRedirect('/api/users/off-email', '/');
    });

    // 회원 탈퇴 버튼 → 확인 시트 열기
    document.getElementById('btnQuitOpen').addEventListener('click', showQuitSheet);
    document.getElementById('btnQuitCancel').addEventListener('click', hideQuitSheet);
    document.getElementById('btnQuitConfirm').addEventListener('click', quitAndRedirect);

    init();
</script>
</body>
</html>