<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>틀린 문제 등록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        .container { max-width: 520px; margin: 48px auto; padding: 24px; }
        .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .center { text-align: center; }
        .row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
        label { font-weight: 600; }
        input, select, button { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
        button { background: #111827; color: #fff; cursor: pointer; border: none; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .msg { margin-bottom: 16px; padding: 10px 12px; border-radius: 10px; display: none; }
        .msg.ok { background: #ecfdf5; color: #065f46; border: 1px solid #10b981; }
        .msg.err { background: #fef2f2; color: #991b1b; border: 1px solid #ef4444; }
        .help { color: #6b7280; font-size: 12px; }
    </style>
</head>
<body>
<div class="container">
    <div id="globalMsg" class="msg"></div>

    <div class="card">
        <h2 class="center" style="margin-top:0">틀린 문제 등록</h2>
        <p id="welcome" class="center help">불러오는 중...</p>

        <form id="wrongForm" autocomplete="off">
            <div class="row">
                <label for="platformId">플랫폼</label>
                <select id="platformId" name="platformId" required>
                    <option value="" disabled selected>플랫폼을 선택하세요</option>
                </select>
            </div>

            <div class="row">
                <label for="num">문제 번호</label>
                <input id="num" name="num"
                       inputmode="numeric" pattern="[0-9]*" required
                       placeholder="숫자만 입력" type="number">
            </div>

            <div class="row">
                <label for="date">틀린 날짜</label>
                <input id="date" name="date" type="date" required>
            </div>

            <input type="hidden" id="_csrfParam" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
            <!-- 등록/로그아웃 버튼 영역 -->
            <div style="display: flex; justify-content: space-between; margin-top: 16px;">
                <button id="submitBtn" type="submit">등록</button>
                <button id="logoutBtn" type="button">로그아웃</button>
            </div>
        </form>
        <form id="logoutForm" th:action="@{/auth/logout}" method="post" style="display:none;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </div>
</div>

<script>
    function getCookie(name) {
        return document.cookie
            .split('; ')
            .find(row => row.startsWith(name + '='))
            ?.split('=')[1];
    }

    // ----- 메시지 표시 -----
    function showMessage(text, ok = true) {
        const el = document.getElementById('globalMsg');
        el.textContent = text;
        el.classList.remove('ok', 'err');
        el.classList.add(ok ? 'ok' : 'err');
        el.style.display = 'block';
    }


    function todayStr() {
        const d = new Date();
        const mm = String(d.getMonth()+1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${d.getFullYear()}-${mm}-${dd}`;
    }

    // 초기 데이터 로드
    async function init() {
        document.getElementById('date').value = todayStr();

        // 유저네임 조회
        try {
            const res = await fetch('/api/users/my-username', { credentials: 'include' });
            const text = await res.text();
            document.getElementById('welcome').textContent = `${text}님 반가워요!`;
        } catch (e) {
            document.getElementById('welcome').textContent = '유저네임을 불러오지 못했습니다.';
            showMessage('유저네임 조회 실패', false);
        }

        // 플랫폼 전체 리스트
        try {
            const res = await fetch('/api/platform/all', { credentials: 'include' });
            const data = await res.json();  // JSON 보장됨

            const sel = document.getElementById('platformId');
            sel.innerHTML = '<option value="" disabled selected>플랫폼을 선택하세요</option>';

            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.platformId;   // value는 DB 식별자
                opt.textContent = item.name;   // 표시되는 값은 name
                sel.appendChild(opt);
            });
        } catch (e) {
            showMessage('플랫폼 목록 조회 실패', false);
        }
    }

    // fetch + FormData 전송
    document.getElementById('wrongForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        try {
            const form = e.target;
            const formData = new FormData(form);

            const xsrf = decodeURIComponent(getCookie('XSRF-TOKEN') || '');

            const res = await fetch('/api/wrong', {
                method: 'POST',
                credentials: 'include',
                headers: { 'X-XSRF-TOKEN': xsrf },
                body: formData
            });

            const bodyText = await res.text();
            let displayMsg = bodyText;

            if (!res.ok) {
                try {
                    const json = JSON.parse(bodyText);
                    if (json.message) {
                        displayMsg = json.message;
                    }
                } catch (_) {
                    // JSON parse 실패 시 그냥 body 그대로 출력
                }
            }

            showMessage(displayMsg, res.ok);
        } catch (err) {
            showMessage('요청 실패: ' + (err?.message || 'unknown'), false);
        } finally {
            btn.disabled = false;
        }
    });

    // 로그아웃 버튼 동작
    document.getElementById('logoutBtn').addEventListener('click', () => {
        document.getElementById('logoutForm').submit();
    });
    init();
</script>
</body>
</html>